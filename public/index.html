<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" type="text/css" href="styles.css">
    <script src="https://d3js.org/d3.v6.min.js"></script>
    <script src="https://unpkg.com/three@0.130.1/build/three.min.js"></script>
    <script src="https://unpkg.com/three@0.130.1/examples/js/controls/OrbitControls.js"></script>
    <script src="https://d3js.org/d3.v6.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mathjs/lib/browser/math.js"></script>
    <script src="https://cdn.auth0.com/js/auth0-spa-js/1.13/auth0-spa-js.production.js"></script>

</head>
<body>
    <div id="header">
        <div id="site-logo">
            <img src="images/vectorprojector.png" alt="VectorProjector Logo" />
        </div>
    </div>
    
    <!-- Combined container for search and auth status -->
    <div id="combined-container">
        <div id="search-container">
            <input type="text" id="userInput" placeholder="What topic...">
            <button id="askButton">Ask</button>
        </div>

        <div id="auth-status">
            <span id="user-info"></span>
            <span id="status-icon"></span>
            <button id="btn-login" onclick="login()">Log In</button>
            <button id="btn-logout" onclick="logout()" style="display: none;">Log Out</button>
        </div>
    </div>

    <!-- Main content area -->
    <div id="main-content" style="display: flex;">

        <!-- Tab container -->
        <div style="width: 70%;">

            <!-- Tab links -->
            <div class="tab">
                <button class="tablinks" id="tab-gemini-pro">gemini-pro</button>
                <button class="tablinks" id="tab-gpt-3.5-turbo">gpt-3.5-turbo</button>
                <button class="tablinks" id="tab-claude-v2">claude-v2</button>
                <button class="tablinks" id="tab-gpt-4-0125-preview">gpt-4</button>
                <button class="tablinks" id="tab-mistral-medium">mistral-medium</button>
                <button class="tablinks" id="tab-mistral-large">mistral-large</button>
                <button class="tablinks" id="tab-gpt-4-turbo-preview">gpt-4-turbo</button>
                <button class="tablinks" id="compareTab">Entropy</button>
                <button class="tablinks" id="attributesTab">Attributes</button>
                <!-- Add other model tabs here -->
            </div>
        
            <!-- Tab content -->
            <div id="tab-content">
                <!-- D3 Canvas container, assuming 'text-davinci-003' tab should show this by default -->
                <div id="canvas-container" class="tabcontent" style="display: block;">
                    <div id="my_dataviz"></div>
                </div>
                <div id="compare-container" style="display: none;"></div>
            </div>

        </div>

        <!-- New sidebar container -->
        <div id="new-sidebar-container" style="width: 30%;">
            <!-- Combo box for sidebar selections -->
            <select id="newSidebarSelector">
                <option value="library">Library</option>
                <option value="logs">Logs</option>
                <option value="cubeContent">Cube Analytics</option>
                <option value="groups">Groups and Clustering</option>
                <option value="vectorMetrics">Vector Metrics</option>
            </select>

            <!-- Container for dynamic content -->
            <!-- <div id="dynamic-content"> -->
                    <div id="library" style="display: block;"></div>
                    <div id="promptEditors" style="display: none;"></div>
                    <div id="logsContent" style="display: none;"></div>
                    <div id="modelSelectionContent" style="display: none;"></div>
                    <div id="modelParametersContent" style="display: none;"></div>
                    <div id="cubeContent" style="display: none;">
                        <h3 id="sidebarTitle"></h3> 

                        <!-- Image for Cube Analytics -->
                        <img id="sidebarCubeImage" src="" alt="Cube Image" style="width: 100%; height: auto;">
                    
                        <!-- Canvas for Ratings Bar Chart -->
                        <canvas id="ratingsBarChart"></canvas>
                    </div>
                    <div id="groupsContent" style="display: none;">
                        <p>Groups sidebar:</p>
                        <label for="sphereThreshold">Sphere Threshold (0-10):</label>
                        <input type="range" id="sphereThreshold" name="sphereThreshold" min="0" max="10" step="0.1" value="0.1">
                        <span id="thresholdValue">0.1</span>
                        <label for="minCubesSlider">Min Cubes per Sphere:</label>
                        <input type="range" id="minCubesSlider" min="0" max="10" value="0">
                        <label for="overlapSlider">Max Sphere Overlap (%):</label>
                        <input type="range" id="overlapSlider" min="0" max="100" value="100">
                        <canvas id="groupsContentChart" width="600" height="500"></canvas>
                        <div id="groupsImagesContainer"></div>
                    </div>
                    <div id="vectorMetricsContent" style="display: none;"></div>
            <!-- </div> -->
    </div>

    <script type="module" src="main.js"></script>
    <script type="module" src="sidebar.js"></script>
    <script type="module" src="llmService.js"></script>
    <script type="module" src="listPerpetuator.js"></script>
    <script type="module" src="listProcessor.js"></script>
    <script type="module" src="ratingGenerator.js"></script>
    <script type="module" src="cubeManager.js"></script>
    <script type="module" src="vectorMetrics.js"></script>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script>
        let auth0 = null;

        const initializeAuth0 = async () => {
            try {
                auth0 = await createAuth0Client({
                    domain: 'dev-h3zfs1afk4agsssf.us.auth0.com',
                    client_id: 'vWhUs5xQshlz8Chj7lxs0jQ0wOFtUuiW',
                    redirect_uri: window.location.origin
                });
                updateUI();
            } catch (error) {
                console.error("Error initializing Auth0", error);
            }
        };

        const updateUI = async () => {
        const isAuthenticated = await auth0.isAuthenticated();
        const userInfoDisplay = document.getElementById('user-info');
        const statusIcon = document.getElementById('status-icon');
        
        if (isAuthenticated) {
            const user = await auth0.getUser();
            
            // Display user's name and email
            userInfoDisplay.textContent = `${user.name} (${user.email})`;
            userInfoDisplay.style.display = 'inline';
            
            // Update status icon to green
            statusIcon.style.backgroundColor = 'green';
            
            // Show logout button
            document.getElementById('btn-login').style.display = 'none';
            document.getElementById('btn-logout').style.display = 'inline-block';
        } else {
            // Hide user info and show login button
            userInfoDisplay.style.display = 'none';
            statusIcon.style.backgroundColor = 'black';
            
            document.getElementById('btn-login').style.display = 'inline-block';
            document.getElementById('btn-logout').style.display = 'none';
        }
    };

        window.onload = async () => {
            await initializeAuth0();

            // Check if the user is returning from Auth0 after authentication
            const isAuthenticated = await auth0.isAuthenticated();

            if (isAuthenticated) {
                // User is authenticated
                console.log('User is authenticated');
                updateUI();
            } else {
                // Parse the authentication result
                const query = window.location.search;
                if (query.includes("code=") && query.includes("state=")) {
                    // Process the login state
                    await auth0.handleRedirectCallback();

                    // Update UI
                    updateUI();

                    // Use replaceState to remove code and state from URL
                    window.history.replaceState({}, document.title, "/");
                }
            }
        };


        const login = async () => {
            await auth0.loginWithRedirect();
        };

        const logout = () => {
            auth0.logout({
                returnTo: window.location.origin
            });
        };

</script>
    </body>
    </html>